<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Personal Music Player</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #f0f0f0;
        }
        
        .player-container {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .controls {
            display: flex;
            gap: 10px;
            margin: 20px 0;
            justify-content: center;
        }

        button {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            background: #2196F3;
            color: white;
            cursor: pointer;
        }

        button:disabled {
            background: #ccc;
        }

        #playlist {
            margin-top: 20px;
            max-height: 400px;
            overflow-y: auto;
        }

        .playlist-item {
            padding: 10px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            display: flex;
            align-items: center;
        }

        .playlist-item img {
            width: 50px;
            height: 50px;
            margin-right: 10px;
        }

        .playlist-item:hover {
            background: #f5f5f5;
        }

        .playlist-item.active {
            background: #e3f2fd;
        }

        .url-input {
            width: 100%;
            padding: 10px;
            margin: 10px 0;
        }

        #loading {
            text-align: center;
            padding: 20px;
            display: none;
        }
    </style>
</head>
<body>
    <div class="player-container">
        <h1>Personal Music Player</h1>
        
        <div id="player"></div>
        
        <div class="controls">
            <button id="prevBtn" onclick="previousTrack()">Previous</button>
            <button id="playPauseBtn" onclick="togglePlayPause()">Play</button>
            <button id="nextBtn" onclick="nextTrack()">Next</button>
            <button id="shuffleBtn" onclick="toggleShuffle()">Shuffle</button>
            <button id="repeatBtn" onclick="toggleRepeat()">Repeat</button>
        </div>

        <div>
            <input type="text" id="playlistUrl" class="url-input" placeholder="Enter YouTube Playlist URL">
            <button onclick="loadPlaylist()">Load Playlist</button>
        </div>

        <div id="loading">Loading playlist...</div>
        <div id="playlist"></div>
    </div>

    <script>
        const API_KEY = 'AIzaSyBFbg68x_sooWJt_NOyj3-fXSfG4vKUtDE';
        let player;
        let playlist = [];
        let currentIndex = 0;
        let isShuffleOn = false;
        let isRepeatOn = false;
        
        // Load saved playlist from localStorage
        const savedPlaylist = localStorage.getItem('savedPlaylist');
        if (savedPlaylist) {
            playlist = JSON.parse(savedPlaylist);
        }

        // Initialize YouTube Player API
        const tag = document.createElement('script');
        tag.src = "https://www.youtube.com/iframe_api";
        const firstScriptTag = document.getElementsByTagName('script')[0];
        firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);

        function onYouTubeIframeAPIReady() {
            player = new YT.Player('player', {
                height: '360',
                width: '640',
                events: {
                    'onStateChange': onPlayerStateChange
                }
            });
        }

        function onPlayerStateChange(event) {
            if (event.data === YT.PlayerState.ENDED) {
                if (isRepeatOn) {
                    player.playVideo();
                } else {
                    nextTrack();
                }
            }
            
            // Update play/pause button text
            if (event.data === YT.PlayerState.PLAYING) {
                document.getElementById('playPauseBtn').textContent = 'Pause';
            } else if (event.data === YT.PlayerState.PAUSED) {
                document.getElementById('playPauseBtn').textContent = 'Play';
            }
        }

        function togglePlayPause() {
            const state = player.getPlayerState();
            if (state === YT.PlayerState.PLAYING) {
                player.pauseVideo();
            } else {
                player.playVideo();
            }
        }

        function nextTrack() {
            if (playlist.length === 0) return;
            
            if (isShuffleOn) {
                currentIndex = Math.floor(Math.random() * playlist.length);
            } else {
                currentIndex = (currentIndex + 1) % playlist.length;
            }
            
            player.loadVideoById(playlist[currentIndex].id);
            updateActiveTrack();
        }

        function previousTrack() {
            if (playlist.length === 0) return;
            
            if (isShuffleOn) {
                currentIndex = Math.floor(Math.random() * playlist.length);
            } else {
                currentIndex = (currentIndex - 1 + playlist.length) % playlist.length;
            }
            
            player.loadVideoById(playlist[currentIndex].id);
            updateActiveTrack();
        }

        function toggleShuffle() {
            isShuffleOn = !isShuffleOn;
            document.getElementById('shuffleBtn').style.background = isShuffleOn ? '#1565C0' : '#2196F3';
        }

        function toggleRepeat() {
            isRepeatOn = !isRepeatOn;
            document.getElementById('repeatBtn').style.background = isRepeatOn ? '#1565C0' : '#2196F3';
        }

        async function loadPlaylist() {
            const url = document.getElementById('playlistUrl').value;
            const playlistId = extractPlaylistId(url);
            
            if (!playlistId) {
                alert('Invalid playlist URL');
                return;
            }

            document.getElementById('loading').style.display = 'block';
            
            try {
                const response = await fetch(`https://www.googleapis.com/youtube/v3/playlistItems?part=snippet&maxResults=50&playlistId=${playlistId}&key=${API_KEY}`);
                const data = await response.json();
                
                if (data.error) {
                    throw new Error(data.error.message);
                }

                playlist = data.items.map(item => ({
                    id: item.snippet.resourceId.videoId,
                    title: item.snippet.title,
                    thumbnail: item.snippet.thumbnails.default.url
                }));

                localStorage.setItem('savedPlaylist', JSON.stringify(playlist));
                renderPlaylist();
                
                // Load first track if player is empty
                if (player && (!player.getVideoData() || !player.getVideoData().video_id)) {
                    currentIndex = 0;
                    player.loadVideoById(playlist[0].id);
                }
            } catch (error) {
                alert('Error loading playlist: ' + error.message);
            } finally {
                document.getElementById('loading').style.display = 'none';
            }
        }

        function extractPlaylistId(url) {
            const regex = /[?&]list=([^#\&\?]+)/;
            const match = url.match(regex);
            return match && match[1];
        }

        function renderPlaylist() {
            const playlistElement = document.getElementById('playlist');
            playlistElement.innerHTML = '';
            
            playlist.forEach((item, index) => {
                const div = document.createElement('div');
                div.className = `playlist-item ${index === currentIndex ? 'active' : ''}`;
                div.innerHTML = `
                    <img src="${item.thumbnail}" alt="${item.title}">
                    <span>${item.title}</span>
                `;
                div.onclick = () => {
                    currentIndex = index;
                    player.loadVideoById(item.id);
                    updateActiveTrack();
                };
                playlistElement.appendChild(div);
            });
        }

        function updateActiveTrack() {
            const items = document.getElementsByClassName('playlist-item');
            Array.from(items).forEach((item, index) => {
                item.className = `playlist-item ${index === currentIndex ? 'active' : ''}`;
            });
        }

        // Initial render of saved playlist
        renderPlaylist();
    </script>
</body>
</html>
